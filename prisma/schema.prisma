generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String               @id @default(cuid())
  name                String?
  email               String               @unique
  emailVerified       DateTime?
  password            String?
  image               String?
  phone               String?
  hasWhatsapp         Boolean              @default(false)
  role                Role                 @default(CLIENT)
  registrationIp      String?              // IP address during registration for abuse prevention
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  deletedAt           DateTime?
  accounts            Account[]
  clientSubscriptions ClientSubscription[]
  notifications       Notification[]
  reviewedPayments    PaymentProof[]       @relation("PaymentReviewer")
  paymentProofs       PaymentProof[]
  providerProfile     ProviderProfile?
  ratings             Rating[]             @relation("ClientRatings")
  receivedRatings     Rating[]             @relation("ProviderRatings")
  clientRequests      Request[]            @relation("ClientRequests")
  providerRequests    Request[]            @relation("ProviderRequests")
  comments            RequestComment[]
  sessions            Session[]
  watchedRequests     RequestWatcher[]

  @@index([deletedAt])
  @@index([registrationIp])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RequestWatcher {
  id         String   @id @default(cuid())
  request    Request  @relation(fields: [requestId], references: [id])
  requestId  String
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  createdAt  DateTime @default(now())

  @@unique([requestId, userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ProviderProfile {
  id                String        @id @default(cuid())
  userId            String        @unique
  bio               String?
  portfolio         String?
  skillsTags        String[]      @default([])
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  supportedServices ServiceType[] @relation("ProviderServices")
}

model ServiceType {
  id                        String            @id @default(cuid())
  name                      String            @unique
  description               String?
  nameI18n                  Json?
  descriptionI18n           Json?
  icon                      String?
  formFields                Json?
  attributes                Json? // Custom Q&A for each service: [{question: string, required: boolean, type: 'text'|'select'|'multiselect', options?: string[]}]
  creditCost                Int               @default(1) // Number of credits required to create a request for this service
  maxFreeRevisions          Int               @default(3) // Number of free revisions per request
  paidRevisionCost          Int               @default(1) // Cost in credits for paid revisions
  resetFreeRevisionsOnPaid  Boolean           @default(true) // Whether to reset free revision counter after paid revision
  priorityCostLow           Int               @default(0) // Additional credits for low priority
  priorityCostMedium        Int               @default(1) // Additional credits for medium priority
  priorityCostHigh          Int               @default(2) // Additional credits for high priority
  isActive                  Boolean           @default(true)
  sortOrder                 Int               @default(0)
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  deletedAt                 DateTime?
  requests                  Request[]
  providers                 ProviderProfile[] @relation("ProviderServices")
  packages                  PackageService[]

  @@index([deletedAt])
}

model Package {
  id                        String               @id @default(cuid())
  name                      String
  description               String?
  nameI18n                  Json?
  descriptionI18n           Json?
  featuresI18n              Json?
  credits                   Int
  price                     Float
  durationDays              Int                  @default(30)
  features                  String[]             @default([])
  isActive                  Boolean              @default(true)
  isFreePackage             Boolean              @default(false)
  supportAllServices        Boolean              @default(false)
  sortOrder                 Int                  @default(0)
  version                   Int                  @default(1)
  createdAt                 DateTime             @default(now())
  updatedAt                 DateTime             @updatedAt
  deletedAt                 DateTime?
  subscriptions             ClientSubscription[]
  services                  PackageService[]

  @@index([deletedAt])
}

model PackageService {
  id          String      @id @default(cuid())
  packageId   String
  serviceId   String
  package     Package     @relation(fields: [packageId], references: [id], onDelete: Cascade)
  serviceType ServiceType @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now())

  @@unique([packageId, serviceId])
  @@index([packageId])
  @@index([serviceId])
}

model ClientSubscription {
  id                        String        @id @default(cuid())
  userId                    String
  packageId                 String
  packageVersion            Int           @default(1)
  remainingCredits          Int
  startDate                 DateTime      @default(now())
  endDate                   DateTime
  isActive                  Boolean       @default(true)
  isFreeTrialUsed           Boolean       @default(false)
  cancelledAt               DateTime?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  package                   Package       @relation(fields: [packageId], references: [id])
  user                      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentProof              PaymentProof?

  @@index([userId, isActive])
}

model PaymentProof {
  id              String             @id @default(cuid())
  subscriptionId  String             @unique
  userId          String
  transferImage   String
  senderName      String
  senderBank      String
  senderCountry   String
  amount          Float
  currency        String             @default("USD")
  transferDate    DateTime
  referenceNumber String?
  notes           String?
  status          PaymentStatus      @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  reviewer        User?              @relation("PaymentReviewer", fields: [reviewedBy], references: [id])
  subscription    ClientSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

model Request {
  id                   String           @id @default(cuid())
  title                String
  description          String
  titleI18n            Json?
  descriptionI18n      Json?
  clientId             String
  providerId           String?
  serviceTypeId        String
  status               RequestStatus    @default(PENDING)
  priority             Int              @default(1)
  creditCost           Int              @default(1) // Total credit cost at time of creation
  baseCreditCost       Int              @default(1) // Base cost from service type
  priorityCreditCost   Int              @default(0) // Additional cost from priority
  isRevision           Boolean          @default(false) // Whether this is a revision request
  revisionType         String?          // "free" or "paid"
  formData             Json?
  attributeResponses   Json? // Client's answers to service-specific Q&A: [{question: string, answer: string}]
  attachments          String[]         @default([])
  estimatedDelivery    DateTime?
  currentRevisionCount Int              @default(0)
  totalRevisions       Int              @default(0)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  completedAt          DateTime?
  deletedAt            DateTime?
  rating               Rating?
  client               User             @relation("ClientRequests", fields: [clientId], references: [id], onDelete: Cascade)
  provider             User?            @relation("ProviderRequests", fields: [providerId], references: [id])
  serviceType          ServiceType      @relation(fields: [serviceTypeId], references: [id])
  comments             RequestComment[]
  watchers             RequestWatcher[]

  @@index([clientId, status])
  @@index([providerId, status])
  @@index([status])
  @@index([deletedAt])
}

model RequestComment {
  id        String      @id @default(cuid())
  requestId String
  userId    String
  content   String
  type      CommentType @default(MESSAGE)
  files     String[]    @default([])
  isRead    Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  request   Request     @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([requestId, createdAt])
}

model Rating {
  id         String   @id @default(cuid())
  requestId  String   @unique
  clientId   String
  providerId String
  rating     Int
  reviewText String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  client     User     @relation("ClientRatings", fields: [clientId], references: [id])
  provider   User     @relation("ProviderRatings", fields: [providerId], references: [id])
  request    Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([providerId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

enum Role {
  SUPER_ADMIN
  PROVIDER
  CLIENT
}

enum RequestStatus {
  PENDING
  IN_PROGRESS
  DELIVERED
  REVISION_REQUESTED
  COMPLETED
  CANCELLED
}

enum CommentType {
  MESSAGE
  SYSTEM
  DELIVERABLE
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}
