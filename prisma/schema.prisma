generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String               @id @default(cuid())
  name                String?
  email               String               @unique
  emailVerified       DateTime?
  password            String?
  image               String?
  role                Role                 @default(CLIENT)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  deletedAt           DateTime?
  accounts            Account[]
  clientSubscriptions ClientSubscription[]
  notifications       Notification[]
  reviewedPayments    PaymentProof[]       @relation("PaymentReviewer")
  paymentProofs       PaymentProof[]
  providerProfile     ProviderProfile?
  ratings             Rating[]             @relation("ClientRatings")
  receivedRatings     Rating[]             @relation("ProviderRatings")
  clientRequests      Request[]            @relation("ClientRequests")
  providerRequests    Request[]            @relation("ProviderRequests")
  comments            RequestComment[]
  sessions            Session[]

  @@index([deletedAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ProviderProfile {
  id                String        @id @default(cuid())
  userId            String        @unique
  bio               String?
  portfolio         String?
  skillsTags        String[]      @default([])
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  supportedServices ServiceType[] @relation("ProviderServices")
}

model ServiceType {
  id          String            @id @default(cuid())
  name        String            @unique
  description String?
  icon        String?
  formFields  Json?
  isActive    Boolean           @default(true)
  sortOrder   Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  deletedAt   DateTime?
  requests    Request[]
  providers   ProviderProfile[] @relation("ProviderServices")

  @@index([deletedAt])
}

model Package {
  id               String               @id @default(cuid())
  name             String
  description      String?
  credits          Int
  price            Float
  durationDays     Int                  @default(30)
  maxFreeRevisions Int                  @default(3)
  features         String[]             @default([])
  isActive         Boolean              @default(true)
  isFreePackage    Boolean              @default(false)
  sortOrder        Int                  @default(0)
  version          Int                  @default(1)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  deletedAt        DateTime?
  subscriptions    ClientSubscription[]

  @@index([deletedAt])
}

model ClientSubscription {
  id               String        @id @default(cuid())
  userId           String
  packageId        String
  packageVersion   Int           @default(1)
  remainingCredits Int
  startDate        DateTime      @default(now())
  endDate          DateTime
  isActive         Boolean       @default(true)
  isFreeTrialUsed  Boolean       @default(false)
  cancelledAt      DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  package          Package       @relation(fields: [packageId], references: [id])
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentProof     PaymentProof?

  @@index([userId, isActive])
}

model PaymentProof {
  id              String             @id @default(cuid())
  subscriptionId  String             @unique
  userId          String
  transferImage   String
  senderName      String
  senderBank      String
  senderCountry   String
  amount          Float
  currency        String             @default("USD")
  transferDate    DateTime
  referenceNumber String?
  notes           String?
  status          PaymentStatus      @default(PENDING)
  reviewedBy      String?
  reviewedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  reviewer        User?              @relation("PaymentReviewer", fields: [reviewedBy], references: [id])
  subscription    ClientSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
}

model Request {
  id                   String           @id @default(cuid())
  title                String
  description          String
  clientId             String
  providerId           String?
  serviceTypeId        String
  status               RequestStatus    @default(PENDING)
  priority             Int              @default(1)
  formData             Json?
  attachments          String[]         @default([])
  estimatedDelivery    DateTime?
  currentRevisionCount Int              @default(0)
  totalRevisions       Int              @default(0)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  completedAt          DateTime?
  deletedAt            DateTime?
  rating               Rating?
  client               User             @relation("ClientRequests", fields: [clientId], references: [id], onDelete: Cascade)
  provider             User?            @relation("ProviderRequests", fields: [providerId], references: [id])
  serviceType          ServiceType      @relation(fields: [serviceTypeId], references: [id])
  comments             RequestComment[]

  @@index([clientId, status])
  @@index([providerId, status])
  @@index([status])
  @@index([deletedAt])
}

model RequestComment {
  id        String      @id @default(cuid())
  requestId String
  userId    String
  content   String
  type      CommentType @default(MESSAGE)
  files     String[]    @default([])
  isRead    Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  request   Request     @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([requestId, createdAt])
}

model Rating {
  id         String   @id @default(cuid())
  requestId  String   @unique
  clientId   String
  providerId String
  rating     Int
  reviewText String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  client     User     @relation("ClientRatings", fields: [clientId], references: [id])
  provider   User     @relation("ProviderRatings", fields: [providerId], references: [id])
  request    Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([providerId])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

enum Role {
  SUPER_ADMIN
  PROVIDER
  CLIENT
}

enum RequestStatus {
  PENDING
  IN_PROGRESS
  DELIVERED
  REVISION_REQUESTED
  COMPLETED
  CANCELLED
}

enum CommentType {
  MESSAGE
  SYSTEM
  DELIVERABLE
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}
